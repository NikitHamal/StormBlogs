<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - StormBlogs</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #FDF7F2;
            --text-color: #333;
            --primary-color: #111;
            --border-color: #eee;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--primary-color);
        }

        .logo img {
            height: 26px;
            width: 26px;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .profile-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name-wrapper {
            display: flex;
            align-items: center;
        }

        .profile-info h1 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
        }

        .profile-info p {
            margin: 0;
            color: #666;
        }

        .profile-stats {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
        }

        .tab.active {
            background: var(--primary-color);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f5f5f5;
        }

        .section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section.active {
            display: block;
        }

        .edit-form {
            display: grid;
            gap: 1rem;
            max-width: 600px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            text-decoration: none;
            color: var(--primary-color);
        }

        .form-group label {
            font-weight: 500;
            color: var(--primary-color);
        }

        .form-group input, .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-family: inherit;
        }

        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .article-grid, .draft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .article-card, .draft-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .article-card:hover, .draft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-title {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
        }

        .card-meta {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.9rem;
        }

        .settings-grid {
            display: grid;
            gap: 1.5rem;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .settings-card h3 {
            margin: 0 0 1rem 0;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-stats {
                justify-content: center;
            }

            .tabs {
                overflow-x: auto;
                padding-bottom: 0.5rem;
            }

            .article-grid, .draft-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Add loading overlay styles */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .loading-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .card-description {
            color: #666;
            margin: 0.5rem 0;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }

        .profile-pictures-history {
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .history-item {
            text-align: center;
        }

        .history-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .history-avatar:hover {
            transform: scale(1.1);
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .history-date {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
        }

        .history-item {
            position: relative;
        }

        .history-item::before {
            content: 'Use this';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: 1;
        }

        .history-item:hover::before {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .profile-pictures-history {
                grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            }

            .history-avatar {
                width: 60px;
                height: 60px;
            }
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }

        .insights-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .insights-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        .popular-articles {
            margin-top: 1rem;
        }

        .popular-article-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .popular-article-item:hover {
            background: #f8f9fa;
        }

        .article-rank {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 1rem;
            min-width: 30px;
        }

        .article-info {
            flex: 1;
        }

        .article-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .article-stats {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            gap: 1rem;
        }

        .chart-container {
            height: 300px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .insights-grid {
                grid-template-columns: 1fr;
            }
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            color: #3b82f6;
            font-size: 1.2rem;
        }

        .pro-only {
            position: relative;
        }

        .pro-only::after {
            content: 'PRO';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #3b82f6;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 12px;
            font-weight: 600;
        }

        .profile-viewers {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .viewer-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }

        .viewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 1rem;
        }

        .viewer-info {
            flex: 1;
        }

        .viewer-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .viewer-date {
            font-size: 0.85rem;
            color: #666;
        }

        .stats-row {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .stats-row span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #666;
            font-size: 0.85rem;
        }
        .stats-row i {
            font-size: 1rem;
        }

        .social-inputs {
            display: grid;
            gap: 1rem;
        }

        .social-input {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #f5f5f5;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .social-input i {
            width: 24px;
                text-align: center;
            color: #666;
        }

        .social-input input {
            border: none;
            background: transparent;
            flex: 1;
        }

        .social-input input:focus {
            outline: none;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .avatar-upload {
            position: relative;
            width: 120px;
                margin: 0 auto;
            }

        .avatar-edit {
            position: absolute;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        .avatar-edit input {
            display: none;
        }

        .avatar-edit label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            margin-bottom: 0;
            border-radius: 100%;
            background: var(--primary-color);
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: normal;
            transition: all 0.2s ease-in-out;
        }

        .avatar-edit label:hover {
            background: #000;
            transform: scale(1.05);
        }

        .avatar-edit label i {
            color: white;
            font-size: 14px;
        }

        .avatar-preview {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 100%;
            border: 3px solid var(--primary-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            background: #f8f9fa;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-preview .default-avatar {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #adb5bd;
        }

        .avatar-preview::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .avatar-preview:hover::after {
            opacity: 1;
        }

        .avatar-preview:hover .upload-text {
            opacity: 1;
        }

        .upload-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.8rem;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 2;
            pointer-events: none;
        }

        .avatar-requirements {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- Add loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <header class="header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <img src="logo.png" alt="Logo">
                <h4 style="margin: 0;">/Storm Blogs</h4>
            </a>
        </div>
    </header>

    <div class="container">
        <div class="profile-header">
            <img src="profile.jpg" alt="Profile" class="profile-avatar" id="profileAvatar">
            <div class="profile-info">
                <div class="profile-name-wrapper">
                    <h1 id="profileName">User Name</h1>
                    <span id="verifiedBadge" class="verified-badge" style="display: none;">
                        <i class="fas fa-check-circle"></i>
                    </span>
                </div>
                <p id="profileEmail">user@email.com</p>
                <p id="profileBio">A passionate writer and storyteller.</p>
                <div class="profile-stats">
                    <div class="stat">
                        <div class="stat-number" id="articlesCount">0</div>
                        <div class="stat-label">Articles</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="viewsCount">0</div>
                        <div class="stat-label">Views</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="likesCount">0</div>
                        <div class="stat-label">Likes</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="commentsCount">0</div>
                        <div class="stat-label">Comments</div>
                    </div>
                    <div class="stat pro-only" id="profileViewsStat" style="display: none;">
                        <div class="stat-number" id="profileViewsCount">0</div>
                        <div class="stat-label">Profile Views</div>
                    </div>
                </div>
            </div>
            </div>
            
        <div class="tabs">
            <div class="tab active" data-tab="articles">
                <i class="fas fa-book"></i> My Articles
            </div>
            <div class="tab" data-tab="drafts">
                <i class="fas fa-file-alt"></i> My Drafts
            </div>
            <div class="tab" data-tab="insights">
                <i class="fas fa-chart-line"></i> Insights
            </div>
            <div class="tab" data-tab="edit">
                <i class="fas fa-edit"></i> Edit Profile
            </div>
            <div class="tab" data-tab="settings">
                <i class="fas fa-cog"></i> Settings
            </div>
                </div>
                
        <div class="section active" id="articles">
            <div class="article-grid" id="articlesGrid">
                <!-- Articles will be dynamically added here -->
            </div>
        </div>

        <div class="section" id="drafts">
            <div class="draft-grid" id="draftsGrid">
                <!-- Drafts will be dynamically added here -->
                    </div>
                    </div>

        <div class="section" id="insights">
            <div class="insights-grid">
                <div class="insights-card">
                    <h3>Performance Overview</h3>
                    <div class="insights-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalViews">0</div>
                            <div class="stat-label">Total Views</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalReadTime">0</div>
                            <div class="stat-label">Read Time (mins)</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalLikes">0</div>
                            <div class="stat-label">Total Likes</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalComments">0</div>
                            <div class="stat-label">Total Comments</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="interactionRate">0%</div>
                            <div class="stat-label">Interaction Rate</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="avgReadTime">0</div>
                            <div class="stat-label">Avg. Read Time</div>
                        </div>
                    </div>
                </div>
                <div class="insights-card">
                    <h3>Popular Articles</h3>
                    <div id="popularArticles" class="popular-articles">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                <div class="insights-card">
                    <h3>Reading Time Distribution</h3>
                    <div id="readTimeChart" class="chart-container">
                        <!-- Will be populated with chart -->
                    </div>
                </div>
                <div class="insights-card">
                    <h3>Engagement Trends</h3>
                    <div id="engagementChart" class="chart-container">
                        <!-- Will be populated with chart -->
                    </div>
                </div>
                <div class="insights-card pro-only" id="profileViewersCard" style="display: none;">
                    <h3>Profile Viewers</h3>
                    <div id="profileViewers" class="profile-viewers">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                <div class="insights-card">
                    <h3>Interaction Breakdown</h3>
                    <div id="interactionChart" class="chart-container">
                        <!-- Will be populated with chart -->
                    </div>
                </div>
                    </div>
                </div>

        <div class="section" id="edit">
            <form class="edit-form" id="editProfileForm">
                <div class="form-group">
                    <label for="name">Display Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" name="username" required pattern="[a-zA-Z0-9_]{3,20}" 
                        title="Username must be 3-20 characters long and can only contain letters, numbers, and underscores">
            </div>
                <div class="form-group">
                    <label for="bio">Bio</label>
                    <textarea id="bio" name="bio" rows="4" placeholder="Tell us about yourself..."></textarea>
                </div>
                <div class="form-group">
                    <label for="location">Location</label>
                    <input type="text" id="location" name="location" placeholder="City, Country">
                </div>
                <div class="form-group">
                    <label for="website">Personal Website</label>
                    <input type="url" id="website" name="website" placeholder="https://your-website.com">
                </div>
                <div class="form-group">
                    <label for="occupation">Occupation</label>
                    <input type="text" id="occupation" name="occupation" placeholder="What do you do?">
                </div>
                <div class="form-group">
                    <label for="interests">Interests</label>
                    <input type="text" id="interests" name="interests" placeholder="Comma-separated list of interests">
                </div>
                <div class="form-group">
                    <label for="avatar">Profile Picture</label>
                    <div class="avatar-upload">
                        <div class="avatar-edit">
                            <input type="file" id="avatar" name="avatar" accept="image/*" onchange="previewImage(event)">
                            <label for="avatar">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                        <div class="avatar-preview">
                            <div class="default-avatar" id="defaultAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <img src="" alt="Avatar Preview" id="avatarPreview" style="display: none;">
                            <div class="upload-text">Change Photo</div>
                        </div>
                    </div>
                    <div class="avatar-requirements">
                        Recommended: Square image, max 5MB
                    </div>
                    <div class="profile-pictures-history" id="profilePicturesHistory">
                        <h4 style="grid-column: 1/-1; margin: 0 0 1rem 0; color: #666;">Previous Profile Pictures</h4>
                        <!-- Profile pictures history will be added here -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Social Media Links</label>
                    <div class="social-inputs">
                        <div class="social-input">
                            <i class="fab fa-instagram"></i>
                            <input type="text" id="instagram" placeholder="Instagram username">
                        </div>
                        <div class="social-input">
                            <i class="fab fa-twitter"></i>
                            <input type="text" id="twitter" placeholder="Twitter username">
                        </div>
                        <div class="social-input">
                            <i class="fab fa-linkedin"></i>
                            <input type="text" id="linkedin" placeholder="LinkedIn username">
                        </div>
                        <div class="social-input">
                            <i class="fab fa-github"></i>
                            <input type="text" id="github" placeholder="GitHub username">
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Privacy Settings</label>
                    <div class="checkbox-group">
                        <label>
                            <input type="checkbox" id="showEmail"> Show email on profile
                        </label>
                        <label>
                            <input type="checkbox" id="showLocation"> Show location on profile
                        </label>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </form>
        </div>

        <div class="section" id="settings">
            <div class="settings-grid">
                <div class="settings-card">
                    <h3>Account Settings</h3>
                    <form class="edit-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" name="currentPassword">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword">
                        </div>
                        <button type="submit" class="btn btn-primary">Update Account</button>
                    </form>
                </div>
                <div class="settings-card">
                    <h3>Preferences</h3>
                    <form class="edit-form">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="emailNotifications"> 
                                Receive email notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="darkMode"> 
                                Enable dark mode
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Preferences</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, doc, updateDoc, arrayUnion, getDoc, orderBy, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAnuHbSv6BniMyf3ltSZTSrIFa_92bHB-o",
            authDomain: "storm-blogs.firebaseapp.com",
            projectId: "storm-blogs",
            storageBucket: "storm-blogs.firebasestorage.app",
            messagingSenderId: "158567556221",
            appId: "1:158567556221:web:855dfa074fc5b65e68fd14"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const storage = getStorage();
        const IMGBB_API_KEY = 'cae25a5efbe778e17c1db8b6f4e44cd7';

        // Show loading overlay
        const loadingOverlay = document.getElementById('loadingOverlay');
        
        // Loading management functions
        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.classList.remove('fade-out');
            }
        }

        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('fade-out');
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);
            }
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    z-index: 10000;
                `;
                document.body.appendChild(toastContainer);
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.style.cssText = `
                padding: 12px 24px;
                margin: 8px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                opacity: 0;
                transition: opacity 0.3s ease;
                ${type === 'success' ? 'background: #10b981;' : 'background: #ef4444;'}
            `;
            toast.textContent = message;

            // Add to container and animate
            toastContainer.appendChild(toast);
            requestAnimationFrame(() => {
                toast.style.opacity = '1';
            });

            // Remove after delay
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                    if (toastContainer.children.length === 0) {
                        document.body.removeChild(toastContainer);
                    }
                }, 300);
            }, 3000);
        }

        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    return {
                        url: data.data.url,
                        deleteUrl: data.data.delete_url,
                        timestamp: new Date().toISOString()
                    };
                } else {
                    throw new Error('Failed to upload image');
                }
            } catch (error) {
                console.error('Error uploading to ImgBB:', error);
                throw error;
            }
        }

        // Handle tab switching
        const tabs = document.querySelectorAll('.tab');
        const sections = document.querySelectorAll('.section');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active section
                sections.forEach(s => {
                    s.classList.remove('active');
                    if (s.id === target) {
                        s.classList.add('active');
                    }
                });

                // Update URL hash
                window.location.hash = target;
            });
        });

        // Handle hash change
        function handleHash() {
            const hash = window.location.hash.slice(1) || 'articles';
            const tab = document.querySelector(`.tab[data-tab="${hash}"]`);
            if (tab) {
                tab.click();
            }
        }

        window.addEventListener('hashchange', handleHash);
        handleHash(); // Handle initial hash

        // Load user data
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const userRef = doc(db, "users", user.uid);
                    const docSnapshot = await getDoc(userRef);
                    
                    // If user document doesn't exist, create it
                    if (!docSnapshot.exists()) {
                        await setDoc(userRef, {
                            username: user.displayName || 'Anonymous',
                            email: user.email,
                            avatarUrl: user.photoURL,
                            joinDate: serverTimestamp(),
                            bio: 'A passionate writer and storyteller.',
                            totalViews: 0,
                            totalLikes: 0,
                            totalComments: 0,
                            totalPosts: 0,
                            profileViews: [],
                            verified: false,
                            isPro: false
                        });
                    }

                    // Get the latest user data
                    const userData = docSnapshot.exists() ? docSnapshot.data() : await getDoc(userRef).then(doc => doc.data());
                    
                    // Update profile UI
                    document.getElementById('profileName').textContent = userData.displayName || 'Anonymous';
                    document.getElementById('profileEmail').textContent = userData.email;
                    document.getElementById('profileBio').textContent = userData.bio || 'A passionate writer and storyteller.';
                    document.getElementById('profileAvatar').src = userData.avatarUrl || `https://api.dicebear.com/7.x/avataaars/svg?seed=${user.uid}`;
                    
                    // Load profile pictures history
                    const profilePicturesHistory = document.getElementById('profilePicturesHistory');
                    if (userData.profilePictures && userData.profilePictures.length > 0) {
                        profilePicturesHistory.innerHTML = userData.profilePictures
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .slice(0, 5) // Show last 5 pictures
                            .map(pic => `
                                <div class="history-item">
                                    <img src="${pic.url}" 
                                         alt="Profile picture history" 
                                         class="history-avatar" 
                                         onclick="useHistoryPicture('${pic.url}')"
                                         title="Click to use this picture">
                                    <div class="history-date">
                                        ${new Date(pic.timestamp).toLocaleDateString()}
                        </div>
                                </div>
                            `).join('');
                    } else {
                        profilePicturesHistory.style.display = 'none';
                    }
                    
                    // Update stats
                    document.getElementById('articlesCount').textContent = userData.totalPosts || 0;
                    document.getElementById('viewsCount').textContent = userData.totalViews || 0;
                    document.getElementById('likesCount').textContent = userData.totalLikes || 0;
                    document.getElementById('commentsCount').textContent = userData.totalComments || 0;

                    // Show verified badge if applicable
                    if (userData.verified) {
                        document.getElementById('verifiedBadge').style.display = 'inline-flex';
                    }

                    // Show pro features if applicable
                    if (userData.isPro) {
                        document.getElementById('profileViewsStat').style.display = 'block';
                        document.getElementById('profileViewsCount').textContent = userData.profileViews?.length || 0;
                        document.getElementById('profileViewersCard').style.display = 'block';
                    }

                    // Populate form fields
                    document.getElementById('name').value = userData.displayName || '';
                    document.getElementById('username').value = userData.username || '';
                    document.getElementById('bio').value = userData.bio || '';
                    document.getElementById('location').value = userData.location || '';
                    document.getElementById('website').value = userData.website || '';
                    document.getElementById('occupation').value = userData.occupation || '';
                    document.getElementById('interests').value = userData.interests?.join(', ') || '';
                    document.getElementById('email').value = userData.email || '';

                    // Populate social media fields
                    if (userData.social) {
                        document.getElementById('instagram').value = userData.social.instagram || '';
                        document.getElementById('twitter').value = userData.social.twitter || '';
                        document.getElementById('linkedin').value = userData.social.linkedin || '';
                        document.getElementById('github').value = userData.social.github || '';
                    }

                    // Set privacy checkboxes
                    if (userData.privacy) {
                        document.getElementById('showEmail').checked = userData.privacy.showEmail || false;
                        document.getElementById('showLocation').checked = userData.privacy.showLocation || false;
                    }

                    // Set avatar preview
                    if (userData.avatarUrl) {
                        const defaultAvatar = document.getElementById('defaultAvatar');
                        const avatarPreview = document.getElementById('avatarPreview');
                        defaultAvatar.style.display = 'none';
                        avatarPreview.style.display = 'block';
                        avatarPreview.src = userData.avatarUrl;
                    }

                    // Load user's articles
                    try {
                        // First check if user has any posts without ordering
                        const basicQuery = query(
                        collection(db, "posts"),
                            where("authorId", "==", user.uid)
                        );
                        
                        const checkSnapshot = await getDocs(basicQuery);
                        const articlesGrid = document.getElementById('articlesGrid');
                        
                        if (checkSnapshot.empty) {
                            articlesGrid.innerHTML = `
                                <div style="text-align: center; padding: 2rem;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                                    <p style="color: #666;">No articles yet</p>
                        </div>
                    `;
                    return;
                }

                        // If user has posts, proceed with ordered query
                        const articlesQuery = query(
                            collection(db, "posts"),
                            where("authorId", "==", user.uid),
                            orderBy("timestamp", "desc")
                        );

                        try {
                            const articlesSnapshot = await getDocs(articlesQuery);
                            articlesGrid.innerHTML = '';

                            if (articlesSnapshot.empty) {
                                articlesGrid.innerHTML = `
                                    <div style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                                        <p style="color: #666;">No articles yet</p>
                                    </div>
                                `;
                            } else {
                                articlesSnapshot.forEach(doc => {
                                    const article = doc.data();
                                    const card = createArticleCard(doc.id, article);
                                    articlesGrid.appendChild(card);
                                });
                            }
            } catch (error) {
                            // Handle index error gracefully
                            if (error.code === 'failed-precondition' || error.message.includes('requires an index')) {
                                articlesGrid.innerHTML = `
                                    <div style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 1rem;"></i>
                                        <p style="color: #666;">No articles yet</p>
                                    </div>
                                `;
                            } else {
                                console.error('Error loading articles:', error);
                                articlesGrid.innerHTML = `
                                    <div style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                                        <p style="color: #666;">Error loading articles. Please try again later.</p>
                    </div>
                `;
            }
                        }
                    } catch (error) {
                        console.error('Error checking for articles:', error);
                        document.getElementById('articlesGrid').innerHTML = `
                            <div style="text-align: center; padding: 2rem;">
                                <i class="fas fa-exclamation-circle" style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;"></i>
                                <p style="color: #666;">Error loading articles. Please try again later.</p>
                            </div>
                        `;
                    }

                    hideLoading();
                } catch (error) {
                    console.error("Error loading profile:", error);
                    showToast('Error loading profile', 'error');
                    hideLoading();
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        // Helper function to create article card
        function createArticleCard(id, article) {
            const card = document.createElement('div');
            card.className = 'article-card';
            card.onclick = () => window.location.href = `read.html?id=${id}`;

            const content = article.content || '';
            const plainText = content.replace(/<[^>]*>/g, '');
            const excerpt = plainText.substring(0, 150) + '...';

            card.innerHTML = `
                <div class="card-content">
                    <h3 class="card-title">${article.title || 'Untitled'}</h3>
                    <p class="card-description">${excerpt}</p>
                    <div class="card-meta">
                        <span>${article.timestamp ? new Date(article.timestamp.toDate()).toLocaleDateString() : 'No date'}</span>
                        <div class="stats-row">
                            <span><i class="fas fa-eye"></i> ${article.views || 0}</span>
                            <span><i class="fas fa-heart"></i> ${article.likes?.length || 0}</span>
                            <span><i class="fas fa-comment"></i> ${article.comments?.length || 0}</span>
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        async function useHistoryPicture(url) {
            if (confirm('Do you want to use this profile picture?')) {
                loadingOverlay.style.display = 'flex';
                try {
                    const user = auth.currentUser;
                    await updateProfile(user, { photoURL: url });
                    await updateDoc(doc(db, "users", user.uid), {
                        avatarUrl: url
                    });
                    showToast('Profile picture updated successfully!', 'success');
                    setTimeout(() => location.reload(), 1000);
                } catch (error) {
                    console.error('Error updating profile picture:', error);
                    showToast('Error updating profile picture. Please try again.', 'error');
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        // Expose the useHistoryPicture function to the window object
        window.useHistoryPicture = useHistoryPicture;

        document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            loadingOverlay.style.display = 'flex';

            try {
                const user = auth.currentUser;
                const newName = document.getElementById('name').value.trim();
                const newUsername = document.getElementById('username').value.trim();
                const newBio = document.getElementById('bio').value.trim();
                const newLocation = document.getElementById('location').value.trim();
                const newWebsite = document.getElementById('website').value.trim();
                const newOccupation = document.getElementById('occupation').value.trim();
                const newInterests = document.getElementById('interests').value.trim();
                const avatarFile = document.getElementById('avatar').files[0];
                const showEmail = document.getElementById('showEmail').checked;
                const showLocation = document.getElementById('showLocation').checked;

                // Validate username
                if (newUsername.length < 3) {
                    throw new Error('Username must be at least 3 characters long');
                }
                if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                    throw new Error('Username can only contain letters, numbers, and underscores');
                }

                // Check if username is taken (if changed)
                const userDoc = await getDoc(doc(db, "users", user.uid));
                const currentUsername = userDoc.data()?.username;
                if (newUsername !== currentUsername) {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("username", "==", newUsername));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        throw new Error('Username is already taken');
                    }
                }

                // Validate website URL if provided
                if (newWebsite && !isValidURL(newWebsite)) {
                    throw new Error('Please enter a valid website URL');
                }

                let photoData = null;
                if (avatarFile) {
                    if (avatarFile.size > 5 * 1024 * 1024) {
                        throw new Error('Image size should be less than 5MB');
                    }
                    photoData = await uploadToImgBB(avatarFile);
                }

                // Update auth profile
                await updateProfile(user, {
                    displayName: newName,
                    photoURL: photoData ? photoData.url : user.photoURL
                });

                // Get reference to user document
                const userRef = doc(db, "users", user.uid);

                // Prepare update data
                const updateData = {
                    username: newUsername,
                    displayName: newName,
                    bio: newBio,
                    location: newLocation,
                    website: newWebsite,
                    occupation: newOccupation,
                    interests: newInterests ? newInterests.split(',').map(i => i.trim()).filter(i => i) : [],
                    lastUpdated: serverTimestamp(),
                    social: {
                        instagram: document.getElementById('instagram').value.trim(),
                        twitter: document.getElementById('twitter').value.trim(),
                        linkedin: document.getElementById('linkedin').value.trim(),
                        github: document.getElementById('github').value.trim()
                    },
                    privacy: {
                        showEmail,
                        showLocation
                    }
                };

                if (photoData) {
                    updateData.avatarUrl = photoData.url;
                    updateData.profilePictures = arrayUnion({
                        url: photoData.url,
                        deleteUrl: photoData.deleteUrl,
                        timestamp: Date.now()
                    });
                }

                // Update user document
                await updateDoc(userRef, updateData);

                showToast('Profile updated successfully!', 'success');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast(error.message || 'Error updating profile. Please try again.', 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        function isValidURL(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        window.previewImage = function(event) {
            const file = event.target.files[0];
            const defaultAvatar = document.getElementById('defaultAvatar');
            const avatarPreview = document.getElementById('avatarPreview');
            
            if (file) {
                // Validate file size
                if (file.size > 5 * 1024 * 1024) { // 5MB
                    showToast('Image size should be less than 5MB', 'error');
                    return;
                }

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('Please select an image file', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create a new image to check dimensions
                    const img = new Image();
                    img.onload = function() {
                        // Check if image is reasonably square
                        const ratio = this.width / this.height;
                        if (ratio < 0.75 || ratio > 1.33) {
                            showToast('For best results, use a square image', 'warning');
                        }
                        
                        // Show preview
                        defaultAvatar.style.display = 'none';
                        avatarPreview.style.display = 'block';
                        avatarPreview.src = e.target.result;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                // Reset to default
                defaultAvatar.style.display = 'flex';
                avatarPreview.style.display = 'none';
                avatarPreview.src = '';
            }
        };
    </script>
</body>
</html>