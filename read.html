<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>StormBlogs - Read Article</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAnuHbSv6BniMyf3ltSZTSrIFa_92bHB-o",
      authDomain: "storm-blogs.firebaseapp.com",
      projectId: "storm-blogs",
      storageBucket: "storm-blogs.firebasestorage.app",
      messagingSenderId: "158567556221",
      appId: "1:158567556221:web:855dfa074fc5b65e68fd14"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            checkUserLike();
        }
    });

    // Fetch the post from Firestore
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');
    console.log("Post ID from URL:", postId);

    async function loadPost() {
        if (!postId) {
            console.error("No post ID provided");
            document.getElementById("article-content").innerHTML = "<p>Article not found</p>";
            return;
        }

        const docRef = doc(db, "posts", postId);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const post = docSnap.data();
                
                // Update page content
                document.getElementById("article-title").textContent = post.title;
                document.getElementById("article-title-b").textContent = post.title;
                document.getElementById("article-category").textContent = post.category;
                document.getElementById("article-time").textContent = formatTimeAgo(Date.now() - post.timestamp);
                
                // Format content
                const formattedContent = post.content
                    .split('\n')
                    .map(paragraph => paragraph.trim())
                    .filter(paragraph => paragraph.length > 0)
                    .map(paragraph => `<p style="margin-bottom: 1em;">${paragraph}</p>`)
                    .join('');
                
                document.getElementById("article-body").innerHTML = formattedContent;

                // Update like count
                document.getElementById("like-count").textContent = post.likes || 0;
                
                // Check if user has liked the post
                if (currentUser) {
                    const likedBy = post.likedBy || [];
                    if (likedBy.includes(currentUser.uid)) {
                        document.querySelector('#like-btn i').classList.remove('far');
                        document.querySelector('#like-btn i').classList.add('fas');
                    }
                }

                // Load comments
                await loadComments();
            }
        } catch (error) {
            console.error("Error loading post:", error);
            document.getElementById("article-content").innerHTML = "<p>Error loading article</p>";
        }
    }

    async function loadComments() {
        const docRef = doc(db, "posts", postId);
        const docSnap = await getDoc(docRef);
        const post = docSnap.data();
        const comments = post.comments || [];
        
        const commentsHtml = comments.map(comment => `
            <div style="background: #f8f8f8; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="${comment.userPhotoURL || 'profile.jpg'}" alt="Profile" 
                            style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                        <strong>${comment.userName}</strong>
                    </div>
                    <span style="color: #666; font-size: 0.9em;">${formatTimeAgo(Date.now() - comment.timestamp)}</span>
                </div>
                <p style="margin: 0; line-height: 1.5;">${comment.text}</p>
            </div>
        `).join('');
        
        document.getElementById('comments-list').innerHTML = commentsHtml;
        document.getElementById("comment-count").textContent = comments.length;
    }

    // Modify like button handler
    document.getElementById('like-btn').addEventListener('click', async () => {
        if (!currentUser) {
            alert('Please login to like posts');
            window.location.href = 'login.html';
            return;
        }

        const postRef = doc(db, "posts", postId);
        const postDoc = await getDoc(postRef);
        const likedBy = postDoc.data().likedBy || [];
        
        try {
            if (likedBy.includes(currentUser.uid)) {
                // Unlike
                await updateDoc(postRef, {
                    likes: increment(-1),
                    likedBy: arrayRemove(currentUser.uid)
                });
                document.querySelector('#like-btn i').classList.remove('fas');
                document.querySelector('#like-btn i').classList.add('far');
            } else {
                // Like
                await updateDoc(postRef, {
                    likes: increment(1),
                    likedBy: arrayUnion(currentUser.uid)
                });
                document.querySelector('#like-btn i').classList.remove('far');
                document.querySelector('#like-btn i').classList.add('fas');
            }
            // Refresh post data
            await loadPost();
        } catch (error) {
            console.error("Error updating like:", error);
            alert('Error updating like. Please try again.');
        }
    });

    // Modify comment submission
    document.getElementById('submit-comment').addEventListener('click', async () => {
        if (!currentUser) {
            alert('Please login to comment');
            window.location.href = 'login.html';
            return;
        }

        const comment = document.getElementById('comment-input').value;
        if (!comment.trim()) return;
        
        try {
            const postRef = doc(db, "posts", postId);
            await updateDoc(postRef, {
                comments: arrayUnion({
                    text: comment,
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    userPhotoURL: currentUser.photoURL
                })
            });
            
            document.getElementById('comment-input').value = '';
            // Refresh comments immediately
            await loadComments();
        } catch (error) {
            console.error("Error posting comment:", error);
            alert('Error posting comment. Please try again.');
        }
    });

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadPost();
    });

    function formatTimeAgo(milliseconds) {
      const seconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      const weeks = Math.floor(days / 7);
      const months = Math.floor(days / 30);
      const years = Math.floor(days / 365);

      if (years > 0) return `${years} year${years > 1 ? 's' : ''}`;
      if (months > 0) return `${months} month${months > 1 ? 's' : ''}`;
      if (weeks > 0) return `${weeks} week${weeks > 1 ? 's' : ''}`;
      if (days > 0) return `${days} day${days > 1 ? 's' : ''}`;
      if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''}`;
      if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''}`;
      return `${seconds} second${seconds > 1 ? 's' : ''}`;
    }

    function renderArticle(data) {
        // Set category
        document.getElementById('articleCategory').textContent = data.category || '';
        
        // Set title
        document.getElementById('articleTitle').textContent = data.title;
        
        // Set author and date
        document.getElementById('authorName').textContent = data.authorName || 'Anonymous';
        document.getElementById('publishDate').textContent = new Date(data.timestamp.toDate()).toLocaleDateString();
        
        // Set content
        const contentDiv = document.getElementById('articleContent');
        contentDiv.innerHTML = data.content;

        // Render tags
        const tagsContainer = document.getElementById('articleTags');
        tagsContainer.innerHTML = '';
        if (data.themes && data.themes.length > 0) {
            data.themes.forEach(theme => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.textContent = theme;
                tagsContainer.appendChild(tag);
            });
        }

        // Set like count
        const likeCount = document.getElementById('likeCount');
        likeCount.textContent = data.likes ? data.likes.length : 0;

        // Set comment count
        const commentCount = document.getElementById('commentCount');
        commentCount.textContent = data.comments ? data.comments.length : 0;

        // Update like button state
        const likeButton = document.getElementById('likeButton');
        if (auth.currentUser && data.likes && data.likes.includes(auth.currentUser.uid)) {
            likeButton.querySelector('i').classList.remove('far');
            likeButton.querySelector('i').classList.add('fas');
        }
    }
  </script>

  <style>
    .article-content {
        font-size: 1.1rem;
        line-height: 1.8;
        margin-bottom: 30px;
        max-height: 100%; /* Remove any height restrictions */
    }

    /* Quill content styling */
    .ql-editor {
        padding: 0;
        white-space: pre-wrap; /* Preserve whitespace and wrapping */
    }

    .ql-editor p {
        margin: 0 0 1.2em 0; /* Add proper paragraph spacing */
    }

    .ql-editor h1 {
        font-size: 1.8rem;
        font-weight: 600;
        margin: 1em 0 0.5em;
        line-height: 1.3;
    }

    .ql-editor h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 1em 0 0.5em;
        line-height: 1.3;
    }

    .ql-editor h3 {
        font-size: 1.2rem;
        font-weight: 600;
        margin: 1em 0 0.5em;
        line-height: 1.3;
    }

    .ql-editor blockquote {
        border-left: 3px solid #ccc;
        margin: 1.5em 0;
        padding: 0.5em 0 0.5em 1em; /* Adjusted padding */
        font-size: 1.1rem;
        color: #555;
        line-height: 1.6;
    }

    .ql-editor ul,
    .ql-editor ol {
        margin: 0 0 1.2em 0;
        padding-left: 1.5em;
    }

    .ql-editor li {
        margin-bottom: 0.5em;
    }

    .ql-editor em {
        font-style: italic;
    }

    .ql-editor strong {
        font-weight: 600;
    }

    .ql-editor u {
        text-decoration: underline;
    }

    .ql-editor pre {
        background: #f5f5f5;
        padding: 1em;
        border-radius: 4px;
        margin: 1.2em 0;
        overflow-x: auto;
    }

    .ql-editor code {
        background: #f5f5f5;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.9em;
        font-family: monospace;
    }

    /* Ensure proper spacing between different content types */
    .ql-editor > * + * {
        margin-top: 1em;
    }

    /* Adjust container padding */
    .article-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 40px; /* Increased padding */
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    /* Improve readability with max-width for text */
    .article-content {
        max-width: 680px;
        margin: 0 auto 30px;
    }

    @media (max-width: 768px) {
        .article-container {
            margin: 0;
            padding: 20px;
            border-radius: 0;
        }

        .article-content {
            font-size: 1rem;
            line-height: 1.7;
        }

        .ql-editor h1 {
            font-size: 1.6rem;
        }

        .ql-editor h2 {
            font-size: 1.4rem;
        }

        .ql-editor h3 {
            font-size: 1.2rem;
        }
    }
  </style>

</head>
<body style="font-family: 'Poppins', serif; margin: 0; padding: 0; line-height: 1.6; background-color: #FDF7F2; color: #333; scroll-behavior: smooth;">

  <header>
    <div style="display: flex; align-items: center; justify-content: space-between;">
      <div style="display: flex; align-items: center; margin:32px; margin-top:36px;">
        <img onclick="location.href='index.html';" src="logo.png" alt="Logo" style="margin-right: 4px; height:26px; width: 26px; cursor:pointer;">
        <h4 onclick="location.href='index.html';" style="color: #111111; margin: 0; cursor:pointer;">/Storm Blogs</h4>
      </div>
    </div>
  </header>

  <div style="font-size: 14px; margin:32px; margin-top: 0px; font-weight: bold; display: flex; align-items: center; color: #757575; border-bottom: 1px solid #ddd; padding-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">
    <a href="index.html" style="color: #000; text-decoration: none;">HOME</a>
    <span style="margin: 0 5px;"> / </span>
    <a href="articles.html" style="color: #000; text-decoration: none;">ARTICLES</a>
    <span style="margin: 0 5px;"> / </span>
    <span id="article-title-b" style="color: #757575;"></span>
  </div>

  <main style="margin: 32px; margin-top:0px; padding: 8px; padding-top:0px;">
    <div id="article-content">
      <p id="article-category" style="color:black; font-size:12px; font-weight:500; margin-bottom: 8px; background-color:#D7AFFF; border-radius:32px; padding:4px 16px; width:fit-content;"></p>
      <h1 id="article-title" style="margin-bottom: 16px;"></h1>
      <article role="article" id="article-body" style="font-size:16px; font-weight:400; line-height: 2; white-space: pre-line; word-wrap: break-word;"></article>
      <div style="display: flex; align-items: center; margin-top:32px;">
        <img src="profile.jpg" alt="Profile" style="width: 44px; height: 44px; border-radius: 50%; object-fit: cover; margin-right: 8px;">
        <span style="font-weight: 500; font-size: 18px; margin-right:12px;">Nikit Hamal</span>
        <i class="far fa-clock" style="margin-right: 5px;"></i>
        <span id="article-time" style="font-size:14px;"></span>
      </div>

      <!-- Like and Comment Section -->
      <div style="margin-top: 32px; border-top: 1px solid #ddd; padding-top: 16px;">
        <div style="display: flex; gap: 16px; margin-bottom: 24px;">
          <button id="like-btn" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">
            <i class="far fa-heart"></i>
            <span id="like-count">0</span>
          </button>
          <button id="comment-btn" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: #f0f0f0; border-radius: 20px; cursor: pointer;">
            <i class="far fa-comment"></i>
            <span id="comment-count">0</span>
          </button>
        </div>
        
        <!-- Comment Form -->
        <div id="comment-section" style="margin-top: 16px;">
          <textarea id="comment-input" placeholder="Write a comment..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 8px; font-family: 'Poppins', serif;"></textarea>
          <button id="submit-comment" style="padding: 8px 16px; background-color: #111111; color: white; border: none; border-radius: 20px; cursor: pointer;">
            Post Comment
          </button>
        </div>
        
        <!-- Comments List -->
        <div id="comments-list" style="margin-top: 24px;"></div>
      </div>
    </div>
  </main>

</body>
</html>
