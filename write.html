<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Write - StormBlogs</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Add Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: #FDF7F2;
        }

        .write-container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .editor-header {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .title-input {
            width: 100%;
            font-size: 2rem;
            padding: 10px 0;
            border: none;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s ease;
        }

        .title-input:focus {
            outline: none;
            border-color: #111;
        }

        .meta-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            position: relative;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #111;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .theme-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .theme-tag {
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .theme-tag.selected {
            background: #111;
            color: white;
        }

        #editor {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            min-height: 400px;
        }

        .ql-toolbar {
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border: none !important;
            border-bottom: 1px solid #eee !important;
        }

        .ql-container {
            border: none !important;
            font-family: 'Poppins', sans-serif !important;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .action-button {
            padding: 12px 24px;
            border-radius: 30px;
            font-family: 'Poppins', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 1rem;
        }

        .preview-button {
            background: #f0f0f0;
            color: #111;
        }

        .publish-button {
            background: #111;
            color: white;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .preview-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .image-upload {
            margin-bottom: 20px;
            position: relative;
        }

        .image-preview {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            background-size: cover;
            background-position: center;
            margin-top: 10px;
            display: none;
        }

        .upload-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background: #111;
            transition: width 0.3s ease;
            display: none;
        }

        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #111;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }
    </style>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.8.4/firebase-app.js';
        import { getFirestore, collection, addDoc } from 'https://www.gstatic.com/firebasejs/9.8.4/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.8.4/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAnuHbSv6BniMyf3ltSZTSrIFa_92bHB-o",
            authDomain: "storm-blogs.firebaseapp.com",
            projectId: "storm-blogs",
            storageBucket: "storm-blogs.firebasestorage.app",
            messagingSenderId: "158567556221",
            appId: "1:158567556221:web:855dfa074fc5b65e68fd14"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                // Redirect to login if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            // Update user info in header
            document.getElementById('user-name').textContent = user.displayName || user.email.split('@')[0];
            document.getElementById('user-avatar').src = user.photoURL || 'profile.jpg';
            document.getElementById('user-info').style.display = 'flex';
        });

        // Handle form submission
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById("post-form").addEventListener("submit", async function(e) {
                e.preventDefault();
                
                const submitButton = document.getElementById("submit-button");
                submitButton.disabled = true;
                submitButton.textContent = "Publishing...";

                try {
                    const user = auth.currentUser;
                    if (!user) {
                        throw new Error("You must be logged in to publish");
                    }

                    const title = document.getElementById("title").value;
                    const category = document.getElementById("category").value;
                    const content = document.getElementById("content").value;
                    const preview = content.substring(0, 150) + (content.length > 150 ? '...' : '');

                    const newPost = {
                        title,
                        category,
                        content,
                        preview,
                        timestamp: Date.now(),
                        authorId: user.uid,
                        authorName: user.displayName || user.email.split('@')[0],
                        authorPhoto: user.photoURL || 'profile.jpg',
                        likes: 0,
                        likedBy: [],
                        comments: [],
                        featured: false
                    };

                    await addDoc(collection(db, "posts"), newPost);
                    showNotification("Post published successfully!");
                    setTimeout(() => {
                        window.location.href = "articles.html";
                    }, 1500);

                } catch (error) {
                    console.error("Error adding post: ", error);
                    showNotification("Error publishing post. Please try again.", true);
                    submitButton.disabled = false;
                    submitButton.textContent = "Publish Post";
                }
            });
        });

        function showNotification(message, isError = false) {
            const notification = document.getElementById("notification");
            notification.textContent = message;
            notification.style.backgroundColor = isError ? "#ff4444" : "#4CAF50";
            notification.style.display = "block";
            setTimeout(() => {
                notification.style.display = "none";
            }, 3000);
        }

        // Add category selection handling
        document.querySelectorAll('.category-tag').forEach(button => {
            button.addEventListener('click', () => {
                // Remove selected class from all buttons
                document.querySelectorAll('.category-tag').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // Add selected class to clicked button
                button.classList.add('selected');
                
                // Update hidden input
                document.getElementById('category').value = button.dataset.category;
            });
        });

        // Replace the uploadImageToHost function and image input handler
        async function uploadImageToHost(file) {
            const API_KEY = '6d207e02198a847aa98d0a2a901485a5';
            const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
            const API_URL = CORS_PROXY + 'https://freeimage.host/api/1/upload';
            const progress = document.getElementById('uploadProgress');
            const preview = document.getElementById('imagePreview');
            const uploadButton = document.querySelector('.image-upload .action-button');

            // Define progressInterval in the outer scope
            let progressInterval = null;

            try {
                // Start progress animation
                progress.style.transition = 'width 0.3s ease';
                progress.style.width = '0%';
                progress.style.display = 'block';

                // Show loading state
                uploadButton.disabled = true;
                uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

                // Initialize progress simulation
                let progressValue = 0;
                progressInterval = setInterval(() => {
                    if (progressValue < 90) {
                        progressValue += 5;
                        progress.style.width = progressValue + '%';
                    }
                }, 500);

                // Create FormData and append file directly
                const formData = new FormData();
                formData.append('key', API_KEY);
                formData.append('action', 'upload');
                formData.append('source', file);
                formData.append('format', 'json');

                // Make API request with proper headers
                const response = await fetch(API_URL, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Upload response:', data);

                // Clear progress interval
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                if (data.status_code === 200 && data.image && data.image.url) {
                    // Complete progress bar
                    progress.style.width = '100%';
                    return data.image.url;
                } else {
                    throw new Error(data.error?.message || 'Invalid response from server');
                }

            } catch (error) {
                console.error('Image upload error:', error);
                // Reset progress on error
                progress.style.width = '0%';
                
                if (error.message.includes('Failed to fetch')) {
                    throw new Error('Network error: Please check your internet connection or try again later');
                }
                throw error;
            } finally {
                // Clear interval if it exists
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                // Hide progress bar after a delay
                setTimeout(() => {
                    progress.style.width = '0%';
                    progress.style.display = 'none';
                }, 1000);

                // Reset upload button
                uploadButton.disabled = false;
                uploadButton.innerHTML = '<i class="fas fa-image"></i> Add Cover Image';
            }
        }

        // Update the image input handler
        document.getElementById('imageInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type and size
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('Image size should be less than 10MB');
                return;
            }

            const preview = document.getElementById('imagePreview');
            
            try {
                // Show preview immediately
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);

                // Upload to freeimage.host
                const uploadedUrl = await uploadImageToHost(file);
                
                if (uploadedUrl) {
                    imageUrl = uploadedUrl;
                    console.log('Image uploaded successfully:', imageUrl);
                }

            } catch (error) {
                console.error('Upload error:', error);
                alert(error.message || 'Failed to upload image');
                preview.style.display = 'none';
            }
        });

        // Handle themes
        document.getElementById('themeInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                const value = e.target.value.trim();
                if (value) {
                    addTheme(value);
                    e.target.value = '';
                }
            }
        });

        function addTheme(theme) {
            const tagsContainer = document.getElementById('themeTags');
            const tag = document.createElement('div');
            tag.className = 'theme-tag';
            tag.textContent = theme;
            tag.onclick = () => tag.classList.toggle('selected');
            tagsContainer.appendChild(tag);
        }

        async function saveDraft() {
            const content = {
                title: document.getElementById('titleInput').value,
                content: quill.root.innerHTML,
                category: document.getElementById('categoryInput').value,
                themes: Array.from(document.querySelectorAll('.theme-tag.selected'))
                    .map(tag => tag.textContent),
                imageUrl,
                lastSaved: new Date()
            };

            localStorage.setItem('blogDraft', JSON.stringify(content));
            showSaveIndicator();
        }

        function loadDraft() {
            const draft = localStorage.getItem('blogDraft');
            if (draft) {
                const content = JSON.parse(draft);
                document.getElementById('titleInput').value = content.title || '';
                quill.root.innerHTML = content.content || '';
                document.getElementById('categoryInput').value = content.category || '';
                content.themes?.forEach(theme => addTheme(theme));
                if (content.imageUrl) {
                    imageUrl = content.imageUrl;
                    const preview = document.getElementById('imagePreview');
                    preview.style.backgroundImage = `url(${imageUrl})`;
                    preview.style.display = 'block';
                }
            }
        }

        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        function previewPost() {
            const modal = document.getElementById('previewModal');
            const content = document.getElementById('previewContent');
            
            content.innerHTML = `
                <h1>${document.getElementById('titleInput').value}</h1>
                ${quill.root.innerHTML}
            `;
            
            modal.style.display = 'flex';
            modal.onclick = (e) => {
                if (e.target === modal) modal.style.display = 'none';
            };
        }

        async function publishPost() {
            const publishBtn = document.getElementById('publishButton');
            publishBtn.disabled = true;
            publishBtn.innerHTML = '<span class="loading"></span>';

            try {
                if (!document.getElementById('titleInput').value.trim()) {
                    throw new Error('Please enter a title');
                }

                const postData = {
                    title: document.getElementById('titleInput').value,
                    content: quill.root.innerHTML,
                    category: document.getElementById('categoryInput').value,
                    themes: Array.from(document.querySelectorAll('.theme-tag.selected'))
                        .map(tag => tag.textContent),
                    image: imageUrl, // Use the uploaded image URL
                    authorId: auth.currentUser.uid,
                    authorName: auth.currentUser.displayName,
                    timestamp: new Date(),
                    likes: [],
                    comments: []
                };

                await addDoc(collection(db, "posts"), postData);
                localStorage.removeItem('blogDraft');
                window.location.href = 'articles.html';

            } catch (error) {
                console.error('Publish error:', error);
                alert(error.message || 'Failed to publish post');
            } finally {
                publishBtn.disabled = false;
                publishBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Publish';
            }
        }
    </script>
</head>
<body>
    <div class="write-container">
        <div class="editor-header">
            <input type="text" class="title-input" placeholder="Title" id="titleInput">
            <div class="meta-inputs">
                <div class="input-group">
                    <input type="text" placeholder="Category" id="categoryInput">
                </div>
                <div class="input-group">
                    <input type="text" placeholder="Add themes (comma-separated)" id="themeInput">
                </div>
            </div>
            <div class="theme-tags" id="themeTags"></div>
            <div class="image-upload">
                <input type="file" accept="image/*" id="imageInput" style="display: none">
                <button class="action-button preview-button" onclick="document.getElementById('imageInput').click()">
                    <i class="fas fa-image"></i> Add Cover Image
                </button>
                <div class="image-preview" id="imagePreview"></div>
                <div class="upload-progress" id="uploadProgress"></div>
            </div>
        </div>

        <div id="editor"></div>

        <div class="action-buttons">
            <button class="action-button preview-button" onclick="previewPost()">
                <i class="fas fa-eye"></i> Preview
            </button>
            <button class="action-button publish-button" onclick="publishPost()" id="publishButton">
                <i class="fas fa-paper-plane"></i> Publish
            </button>
        </div>
    </div>

    <div class="preview-modal" id="previewModal">
        <div class="preview-content" id="previewContent"></div>
    </div>

    <div class="save-indicator" id="saveIndicator">
        <i class="fas fa-check"></i> Draft saved
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script type="module">
        let quill;
        let imageUrl = '';
        let draftTimeout;
        const AUTOSAVE_DELAY = 2000;

        // Initialize Quill editor
        document.addEventListener('DOMContentLoaded', () => {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Start writing your story...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            // Load draft if exists
            loadDraft();

            // Setup autosave
            quill.on('text-change', () => {
                clearTimeout(draftTimeout);
                draftTimeout = setTimeout(saveDraft, AUTOSAVE_DELAY);
            });
        });
    </script>
</body>
</html>
