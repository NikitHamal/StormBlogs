<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StormBlogs - Login</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAnuHbSv6BniMyf3ltSZTSrIFa_92bHB-o",
            authDomain: "storm-blogs.firebaseapp.com",
            projectId: "storm-blogs",
            storageBucket: "storm-blogs.firebasestorage.app",
            messagingSenderId: "158567556221",
            appId: "1:158567556221:web:855dfa074fc5b65e68fd14"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        // Function to create/update user document in Firestore
        async function updateUserData(user) {
            try {
                const userRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userRef);
                
                if (!userDoc.exists()) {
                    // Create new user document if it doesn't exist
                    await setDoc(userRef, {
                        uid: user.uid,
                        email: user.email,
                        displayName: user.displayName || user.email.split('@')[0],
                        photoURL: user.photoURL || 'profile.jpg',
                        createdAt: serverTimestamp(),
                        lastLogin: serverTimestamp(),
                        posts: [],
                        likes: [],
                        comments: [],
                        restricted: false
                    });
                } else {
                    // Update last login if user already exists
                    await setDoc(userRef, {
                        lastLogin: serverTimestamp()
                    }, { merge: true });
                }
            } catch (error) {
                console.error("Error updating user data:", error);
                showError("Error updating user profile");
            }
        }

        // Google Sign In
        document.getElementById('google-signin').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(async (result) => {
                    await updateUserData(result.user);
                    localStorage.setItem('user', JSON.stringify(result.user));
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    showError(error.message);
                });
        });

        // Email/Password Sign In
        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            signInWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await updateUserData(userCredential.user);
                    localStorage.setItem('user', JSON.stringify(userCredential.user));
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    showError(error.message);
                });
        });

        // Sign Up
        document.getElementById('signup-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    await updateUserData(userCredential.user);
                    localStorage.setItem('user', JSON.stringify(userCredential.user));
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    showError(error.message);
                });
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }
    </script>
</head>
<body style="font-family: 'Poppins', serif; margin: 0; padding: 0; line-height: 1.6; background-color: #FDF7F2; color: #333;">
    <header>
        <div style="display: flex; align-items: center; margin:32px;">
            <img onclick="location.href='index.html';" src="logo.png" alt="Logo" style="margin-right: 4px; height:26px; width: 26px; cursor:pointer;">
            <h4 onclick="location.href='index.html';" style="color: #111111; margin: 0; cursor:pointer;">/Storm Blogs</h4>
        </div>
    </header>

    <main style="max-width: 400px; margin: 32px auto; padding: 20px;">
        <div id="error-message" style="display: none; background-color: #ff4444; color: white; padding: 10px; border-radius: 5px; margin-bottom: 20px;"></div>

        <!-- Login Form -->
        <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Login</h3>
            <form id="login-form">
                <input type="email" id="email" placeholder="Email" required 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                <input type="password" id="password" placeholder="Password" required 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                <button type="submit" style="width: 100%; padding: 10px; background-color: #111; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Login
                </button>
            </form>
        </div>

        <!-- Sign Up Form -->
        <div style="background: white; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
            <h3 style="margin-top: 0;">Sign Up</h3>
            <form id="signup-form">
                <input type="email" id="signup-email" placeholder="Email" required 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                <input type="password" id="signup-password" placeholder="Password" required 
                    style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box;">
                <button type="submit" style="width: 100%; padding: 10px; background-color: #111; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Sign Up
                </button>
            </form>
        </div>

        <!-- Google Sign In -->
        <button id="google-signin" style="width: 100%; padding: 10px; background-color: #4285f4; color: white; border: none; border-radius: 5px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <i class="fab fa-google"></i>
            Sign in with Google
        </button>
    </main>
</body>
</html> 